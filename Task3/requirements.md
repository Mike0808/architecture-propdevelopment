### **3. Список требований к внешним интеграциям**

#### **Требования к безопасности:**

1.  **Конфиденциальность данных:**
    *   Все данные, передаваемые между `smart-home-connector` и `Платформой "Умный дом"`, должны быть зашифрованы с использованием **TLS 1.2 или выше**.
    *   Персональные данные должны либо шифроваться, либо храниться и обрабатываться на стороне партнера, PropDevelopment передает только идентификаторы и настройки доступа.
    *   API должен поддерживать токенизацию чувствительных полей в самих сообщениях.
2.  **Целостность данных:**
    *   API должен использовать механизмы подписи запросов (например, HMAC) или JWT с подписью для проверки подлинности отправителя и неизменности содержимого сообщений.
3.  **Доступность:**
    *   API должен быть доступен с определенным **SLA** (например, 99.9%).
    *   Необходимы механизмы резервирования и отказоустойчивости со стороны партнера.
4.  **Идентификация и Аутентификация:**
    *   Доступ к API партнера для `smart-home-connector` должен осуществляться с использованием уникальных учетных данных сервиса (например, API Key, Client ID/Secret).
    *   Эти учетные данные должны храниться в защищенном хранилище секретов (например, HashiCorp Vault, AWS Secrets Manager) и не хардкодиться в коде или конфигурационных файлах.
5.  **Авторизация:**
    *   API должен поддерживать контроль доступа на уровне атрибутов (ABAC). Например, `smart-home-connector` может управлять домофоном только в конкретных домах/подъездах, соответствующих собственнику.
    *   Использование ролей для ограничения возможных действий.
6.  **Аудит и Логирование:**
    *   Все вызовы API партнера должны логироваться на стороне `smart-home-connector` (запрос, ответ, статус, время) и сегментироваться.
    *   Партнер также должен обеспечивать журналирование критических событий на своей стороне (попытки доступа, срабатывания механизмов).
7.  **Управление инцидентами:**
    *   Партнер должен предоставить интерфейс для информирования об инцидентах безопасности.
    *   Должна быть определена процедура реагирования на инциденты, затрагивающие интеграцию.

#### **Протоколы аутентификации и авторизации:**

1.  **Для вызовов `smart-home-connector` -> `Платформа "Умный дом"`:**
    *   **OAuth 2.0 Client Credentials Grant:** Рекомендуемый стандарт для сервис-сервис аутентификации. `smart-home-connector` получает Access Token у сервера авторизации партнера, используя свои Client ID и Client Secret. Этот токен затем используется в заголовках запросов к API партнера.
    *   **API Key:** Альтернатива, если OAuth 2.0 не поддерживается. Ключ должен передаваться в заголовке (например, `X-API-Key: <value>`) и храниться безопасно.

#### **Организация взаимодействия между системами предприятия и внешней платформой:**

1.  **Архитектурный стиль:** **RESTful API** (или gRPC, если требуется высокая производительность и строгая типизация). Использование асинхронных механизмов (например, Webhooks/Callbacks) для уведомлений от партнера (например, о событиях открытия двери) предпочтительно для масштабируемости.
2.  **Изоляция:** Взаимодействие с внешним API происходит через отдельный сервис (`smart-home-connector`). Это обеспечивает слабую связанность, переиспользуемость и простоту тестирования.
3.  **Обработка ошибок:** `smart-home-connector` должен корректно обрабатывать таймауты, ошибки сети, HTTP-ошибки (4xx, 5xx) от API партнера и возвращать соответствующие ответы внутренним системам.
4.  **Rate Limiting:** `smart-home-connector` может реализовать ограничение количества запросов к API партнера для предотвращения его перегрузки.
5.  **Идемпотентность:** API внешней Платформы "Умный дом" должно поддерживать
идемпотентность для всех операций, которые изменяют состояние системы (например, "открыть дверь", "добавить разрешение для автомобиля"). 
6.  **Кэширование:** Для часто запрашиваемых, но редко изменяемых данных (например, статус оборудования) можно использовать кэширование на стороне `smart-home-connector`.
7.  **Синхронизация данных:** Необходимо определить, как будут синхронизироваться списки доступа (например, кто имеет право открывать дверь). Это может быть:
    *   **Push:** `tenant-core-app` отправляет обновленный список пользователей/автомобилей в `smart-home-connector`, который, в свою очередь, передает его партнеру.
    *   **Pull:** `smart-home-connector` периодически запрашивает у `tenant-core-app` актуальные списки.
    *   **Гибрид:** Использование Push для оперативных изменений и Pull для сверки.
8.  **Мониторинг и метрики:** `smart-home-connector` должен собирать метрики (время отклика API партнера, количество успешных/неуспешных вызовов) для мониторинга состояния интеграции.